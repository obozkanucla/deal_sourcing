27/01/2026
CREATE UNIQUE INDEX IF NOT EXISTS
idx_deals_source_canonical_external_id
ON deals(source, canonical_external_id)
WHERE canonical_external_id IS NOT NULL;

25/01/2026
ALTER TABLE deals ADD COLUMN attributes TEXT;

ALTER TABLE deals ADD COLUMN canonical_external_id TEXT;
ALTER TABLE deals ADD COLUMN broker_name TEXT;
ALTER TABLE deals ADD COLUMN broker_listing_url TEXT;
ALTER TABLE deals ADD COLUMN source_role TEXT DEFAULT 'PRIMARY';
-- PRIMARY | AGGREGATOR

CREATE UNIQUE INDEX idx_canonical_external_id
ON deals(canonical_external_id)
WHERE canonical_external_id IS NOT NULL;


24/01/2026
UPDATE deals
SET
  first_seen   = substr(first_seen, 1, 10),
  last_seen    = substr(last_seen, 1, 10),
  last_updated = substr(last_updated, 1, 10);

20/01/2026
UPDATE deals
SET industry = 'Consumer_Retail'
WHERE source = 'Knightsbridge'
  AND industry = 'Consumer_Services';

UPDATE deals
SET industry = 'Construction_Built_Environment'
WHERE source = 'Knightsbridge'
  AND industry = 'Real_Estate';



15/01/2026

DELETE FROM deals
WHERE source = 'transworld_uk'
  AND source_url IN (
      SELECT source_url
      FROM deals
      WHERE source = 'transworld_uk'
      GROUP BY source_url
      HAVING COUNT(*) > 1
  )
  AND source_listing_id NOT LIKE 'TW-%';


CREATE UNIQUE INDEX IF NOT EXISTS
ux_tw_source_url
ON deals(source, source_url)
WHERE source = 'transworld_uk';



14/01/2026
CREATE UNIQUE INDEX IF NOT EXISTS
ux_bb_source_url
ON deals(source, source_url)
WHERE source = 'BusinessBuyers';

CREATE UNIQUE INDEX IF NOT EXISTS
ux_b4s_source_url
ON deals(source, source_url)
WHERE source = 'BusinessesForSale';

DELETE FROM deals
WHERE source = 'BusinessBuyers'
  AND pdf_drive_url IS NULL
  AND description IS NULL
  AND industry IS NULL;

ALTER TABLE deals
ADD COLUMN added_at DATE;

UPDATE deals
SET drive_folder_url = 'https://drive.google.com/drive/folders/' || drive_folder_id
WHERE source = 'transworld_uk'
  AND drive_folder_id IS NOT NULL
  AND drive_folder_url IS NULL;

DELETE FROM deals
WHERE source = 'transworld_uk'
AND source_listing_id NOT LIKE 'TW-%'
AND EXISTS (
SELECT 1
FROM deals d2
WHERE d2.source = 'transworld_uk'
AND d2.source_listing_id LIKE 'TW-%'
AND d2.source_url = deals.source_url
);


UPDATE deals
SET source_listing_id = 'TW-SOLD-' || source_listing_id
WHERE source = 'transworld_uk'
  AND status = 'Lost'
  AND source_listing_id NOT LIKE 'TW-%';

UPDATE deals
SET
    industry = NULL,
    sector = NULL,
    sector_source = NULL,
    sector_inference_confidence = NULL,
    sector_inference_reason = NULL,
    drive_folder_id = NULL,
    drive_folder_url = NULL,
    pdf_drive_url = NULL,
    needs_detail_refresh = 1,
    detail_fetched_at = NULL,
    detail_fetch_reason = NULL
WHERE source = 'Knightsbridge'
  AND drive_folder_id IS NULL
  AND status IS NULL;


DELETE FROM deal_artifacts WHERE deal_id IS NULL;

DELETE FROM deal_artifacts
WHERE deal_id NOT IN (SELECT id FROM deals);

DELETE FROM deals
WHERE source = 'Knightsbridge';



12/01/2026
CREATE TABLE IF NOT EXISTS deal_status_history (
    deal_id            TEXT NOT NULL,
    old_status         TEXT,
    new_status         TEXT,
    changed_at         TEXT NOT NULL
);


11/01/2026
UPDATE deals
SET
    detail_fetched_at    = CURRENT_TIMESTAMP,
    needs_detail_refresh = 0,
    detail_fetch_reason  = 'REQUIRES_MANUAL_SECTOR_ASSIGNMENT',
    last_updated         = CURRENT_TIMESTAMP,
    last_updated_source  = 'AUTO'
WHERE source = 'Knightsbridge'
  AND detail_fetch_reason = 'MISSING_SECTOR_CANONICAL'
  AND detail_fetched_at IS NULL;


UPDATE deals
SET
    detail_fetch_reason = NULL,
    last_updated = CURRENT_TIMESTAMP,
    last_updated_source = 'AUTO'
WHERE source = 'Knightsbridge'
  AND detail_fetch_reason = 'MISSING_SECTOR_CANONICAL'
  AND industry IS NOT NULL
  AND sector IS NOT NULL;

UPDATE deals
SET
    industry                    = 'Business_Services',
    sector                      = 'Facilities Management',
    sector_source               = 'manual',
    sector_inference_confidence = 1.0,
    sector_inference_reason     = 'manual_final_resolution',

    detail_fetched_at           = CURRENT_TIMESTAMP,
    needs_detail_refresh        = 0,
    detail_fetch_reason         = NULL,

    last_updated                = CURRENT_TIMESTAMP,
    last_updated_source         = 'AUTO'
WHERE source = 'Knightsbridge'
  AND source_listing_id = '166105';


UPDATE deals
SET
    industry                    = 'Healthcare',
    sector                      = 'Medical Devices / Equipment',
    sector_source               = 'manual',
    sector_inference_confidence = 1.0,
    sector_inference_reason     = 'manual_final_resolution',

    detail_fetched_at           = CURRENT_TIMESTAMP,
    needs_detail_refresh        = 0,
    detail_fetch_reason         = NULL,

    last_updated                = CURRENT_TIMESTAMP,
    last_updated_source         = 'AUTO'
WHERE source = 'Knightsbridge'
  AND source_listing_id = '165799';

UPDATE deals
SET
    detail_fetch_reason  = NULL,
    last_updated         = CURRENT_TIMESTAMP,
    last_updated_source  = 'AUTO'
WHERE source = 'Knightsbridge'
  AND detail_fetch_reason = 'cannot access local variable ''e'' where it is not associated with a value'
  AND industry IS NOT NULL
  AND sector IS NOT NULL
  AND needs_detail_refresh = 0;

backfill_knightsbridge_sectors
backfill_knightsbridge_sectors_pass2
backfill_knightsbridge_sectors_pass3
backfill_axis_kb_numeric_fields

10/01/2026
UPDATE deals
SET last_updated_source = 'AUTO'
WHERE source = 'AxisPartnership'
  AND detail_fetched_at IS NOT NULL
  AND last_updated_source IS NULL;

UPDATE deals
SET last_updated_source = 'AUTO'
WHERE source = 'BusinessesForSale'
  AND detail_fetched_at IS NOT NULL
  AND last_updated_source IS NULL;


DELETE FROM deal_artifacts
WHERE broker = 'AxisPartnership'
  AND artifact_type = 'pdf'
  AND deal_id NOT IN (
      SELECT id FROM deals
      WHERE source = 'AxisPartnership'
  );

DROP TABLE IF EXISTS deal_artifacts;

CREATE TABLE deal_artifacts (
    id INTEGER PRIMARY KEY AUTOINCREMENT,

    -- canonical broker identity (AUTHORITATIVE)
    source               TEXT NOT NULL,
    source_listing_id    TEXT NOT NULL,

    -- optional convenience pointer (NON-AUTHORITATIVE)
    deal_id              INTEGER NULL,

    -- artifact identity
    artifact_type        TEXT NOT NULL,     -- pdf, html, snapshot
    artifact_name        TEXT NOT NULL,
    artifact_hash        TEXT NOT NULL,

    -- storage
    drive_file_id        TEXT NOT NULL,
    drive_url            TEXT NOT NULL,

    -- provenance
    created_at           DATETIME NOT NULL,
    created_by           TEXT NOT NULL,
    extraction_version   TEXT NULL,

    -- safety
    UNIQUE (
        source,
        source_listing_id,
        artifact_type,
        artifact_hash
    )
);

CREATE INDEX idx_artifacts_lookup
ON deal_artifacts(source, source_listing_id);

CREATE UNIQUE INDEX IF NOT EXISTS uniq_artifact_hash
ON deal_artifacts(artifact_hash);

run axisenrichment