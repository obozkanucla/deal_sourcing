PRAGMA table_info(deals);

SELECT
    source_listing_id,
    title,
    drive_folder_id,
    drive_folder_url,
    pdf_drive_url, industry, sector_raw
FROM deals
WHERE source = 'DealOpportunities'
  AND source_listing_id = 'S12319';

-- sanity check first
SELECT id, source_listing_id
FROM deals
WHERE source = 'BusinessBuyers'
  AND source_listing_id GLOB '*[^0-9]*';

-- then delete
DELETE FROM deals
WHERE source = 'BusinessBuyers'
  AND source_listing_id GLOB '*[^0-9]*';

-- verify
SELECT id, source_listing_id
FROM deals
WHERE source = 'BusinessBuyers';




CREATE TABLE deals_v2 (
    id INTEGER PRIMARY KEY AUTOINCREMENT,

    -- Identity
    source TEXT NOT NULL,
    source_listing_id TEXT NOT NULL,
    source_url TEXT,

    -- Core descriptors
    title TEXT,
    industry TEXT,
    sector TEXT,
    location TEXT,
    incorporation_year INTEGER,

    -- Financials
    revenue_k REAL,
    ebitda_k REAL,
    asking_price_k REAL,
    profit_margin_pct REAL,
    revenue_growth_pct REAL,
    leverage_pct REAL,

    -- Calculated metrics
    ebitda_margin REAL,
    revenue_multiple REAL,
    ebitda_multiple REAL,

    -- Analyst workflow
    status TEXT,
    owner TEXT,
    priority TEXT,
    notes TEXT,

    -- Decisioning
    decision TEXT,
    decision_reason TEXT,

    -- Lifecycle
    first_seen DATETIME,
    last_seen DATETIME,
    last_updated DATETIME,
    last_updated_source TEXT,   -- 'AUTO' | 'MANUAL'

    -- Assets
    drive_folder_url TEXT,

    UNIQUE (source, source_listing_id)
);

WITH effective_state AS (
    SELECT
        source,
        industry,
        CASE
            WHEN status IS NULL
                 AND julianday('now') - julianday(first_seen) > 7
                THEN 'not_decided'
            WHEN status IS NULL
                THEN 'new'
            ELSE LOWER(REPLACE(status, ' ', '_'))
        END AS state
    FROM deals
)
INSERT INTO weekly_pipeline_snapshots
SELECT
    DATE('now') AS snapshot_date,
    industry,
    state,
    source,
    COUNT(*) AS deal_count
FROM effective_state
GROUP BY industry, state, source;

CREATE TABLE pipeline_snapshots (
    snapshot_year      INTEGER NOT NULL,
    snapshot_week      INTEGER NOT NULL,
    snapshot_key       TEXT    NOT NULL,   -- e.g. "2026-W02"

    industry           TEXT    NOT NULL,
    status              TEXT    NOT NULL,
    source             TEXT    NOT NULL,

    deal_count         INTEGER NOT NULL,

    snapshot_run_date  DATE    NOT NULL,
    created_at         DATETIME DEFAULT CURRENT_TIMESTAMP,

    PRIMARY KEY (snapshot_key, industry, status, source)
);