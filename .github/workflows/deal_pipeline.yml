name: Deal Sourcing Pipeline

on:
  schedule:
    - cron: "0 5 * * *"   # daily at 05:00 UTC
  workflow_dispatch:

jobs:
  pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    env:
      PLAYWRIGHT_HEADLESS: "1"

      # Brokers
      BB_USERNAME: ${{ secrets.BB_USERNAME }}
      BB_PASSWORD: ${{ secrets.BB_PASSWORD }}

      # Slack
      SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
      SLACK_CHANNEL: ${{ secrets.SLACK_CHANNEL }}

      # Google APIs
      GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
      GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
      GOOGLE_REFRESH_TOKEN: ${{ secrets.GOOGLE_REFRESH_TOKEN }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Playwright browsers
        run: python -m playwright install chromium --with-deps

      - name: Restore SQLite DB cache
        uses: actions/cache@v4
        with:
          path: db/deals.sqlite
          key: deals-sqlite-${{ github.run_id }}
          restore-keys: |
            deals-sqlite-

 # --------------------------------------------------
      # Phase 0 — Legacy imports
      # --------------------------------------------------
      - name: Import legacy deals
        run: python -m src.scripts.import_legacy_deals

      - name: Import Dmitry deals
        run: python -m src.scripts.import_dmitry_deals

      # --------------------------------------------------
      # Phase 1 — Broker imports
      # --------------------------------------------------
      - name: Import Axis Partnership
        run: python -m src.scripts.import_axispartnership

      - name: Import BusinessBuyers
        run: python -m src.scripts.import_businessbuyers

      - name: Import BusinessesForSale
        run: python -m src.scripts.import_businesses4sale

      - name: Import DealOpportunities
        run: python -m src.scripts.import_dealopportunities

      - name: Import Knightsbridge
        run: python -m src.scripts.import_knightsbridge

      # --------------------------------------------------
      # Phase 2 — Enrichment
      # --------------------------------------------------
      - name: Enrich Axis Partnership
        run: python -m src.scripts.enrich_axispartnership

      - name: Enrich BusinessBuyers
        run: python -m src.scripts.enrich_businessbuyers

      - name: Enrich BusinessesForSale
        run: python -m src.scripts.enrich_businesses4sale

      - name: Enrich DealOpportunities
        run: python -m src.scripts.enrich_dealopportunities

      - name: Enrich Knightsbridge
        run: python -m src.scripts.enrich_knightsbridge

      # --------------------------------------------------
      # Phase 3 — Intelligence
      # --------------------------------------------------
      - name: Infer sectors + move Drive folders
        run: python -m src.scripts.infer_sectors

      - name: Enrich financials from descriptions
        run: python -m src.scripts.enrich_financials_from_description

      - name: Recalculate financial metrics
        run: python -m src.scripts.recalculate_financial_metrics

      # --------------------------------------------------
      # Phase 4 — Sync outputs
      # --------------------------------------------------
      - name: Sync SQLite → Google Sheets
        run: python -m src.scripts.sync_to_sheets

      # --------------------------------------------------
      # Persist DB artifact
      # --------------------------------------------------
      - name: Upload SQLite artifact
        uses: actions/upload-artifact@v4
        with:
          name: deals-sqlite
          path: db/deals.sqlite