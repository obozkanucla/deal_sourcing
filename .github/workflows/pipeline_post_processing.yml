name: Pipeline - Post Processing

on:
  schedule:
    - cron: "0 6 */2 * *" # at 6AM every other day
  workflow_dispatch:

permissions:
  contents: write   # required for GitHub Releases
  actions: read

jobs:
  pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    env:
      PLAYWRIGHT_HEADLESS: "1"

      # -----------------------------
      # Broker credentials
      # -----------------------------
      BB_USERNAME: ${{ secrets.BB_USERNAME }}
      BB_PASSWORD: ${{ secrets.BB_PASSWORD }}
      # -----------------------------
      # Knightsbridge credentials
      # -----------------------------
      KB_USERNAME: ${{ secrets.KB_USERNAME }}
      KB_PASSWORD: ${{ secrets.KB_PASSWORD }}
      # -----------------------------
      # Slack
      # -----------------------------
      SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
      SLACK_CHANNEL: ${{ secrets.SLACK_CHANNEL }}

      # -----------------------------
      # Google APIs (OAuth user)
      # -----------------------------
      GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
      GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
      GOOGLE_REFRESH_TOKEN: ${{ secrets.GOOGLE_REFRESH_TOKEN }}

      # -----------------------------
      # Pipeline safety
      # -----------------------------
      PIPELINE_ENV: github

    steps:
      - name: Record start time
        run: echo "JOB_START_TS=$(date +%s)" >> $GITHUB_ENV
      # --------------------------------------------------
      # Checkout code
      # --------------------------------------------------
      - name: Checkout repo
        uses: actions/checkout@v4

      # --------------------------------------------------
      # Python
      # --------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # --------------------------------------------------
      # Playwright
      # --------------------------------------------------
      - name: Install Playwright browsers
        run: |
          python -m playwright install chromium --with-deps

      # --------------------------------------------------
      # Restore canonical SQLite DB from GitHub Release
      # --------------------------------------------------
      - name: Download latest SQLite DB from release (if exists)
        run: |
          mkdir -p db
          gh release download db-latest \
            --pattern deals.sqlite \
            --output db/deals.sqlite \
            --clobber || echo "No existing DB found — starting fresh"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # --------------------------------------------------
      # Phase 0 — Legacy imports
      # --------------------------------------------------
      - name: Import legacy deals
        run: python -m src.scripts.import_legacy_deals

      - name: Import Dmitry deals
        run: python -m src.scripts.import_dmitry_deals

      # --------------------------------------------------
      # Phase 1 — Post Processing
      # --------------------------------------------------
      - name: Infer sectors + move Drive folders
        run: python -m src.scripts.run_pipeline_postprocess

      # --------------------------------------------------
      # Phase 4a — Data Phase
      # --------------------------------------------------
      - name: Sheets DATA phase (retry-safe)
        run: |
          set -e
          for i in 1 2 3; do
            echo "▶ DATA phase attempt $i"
            SHEETS_PHASE=DATA python -m src.scripts.sync_to_sheets && exit 0
            sleep $((i * 15))
          done
          exit 1

      # --------------------------------------------------
      # Phase 4b — Format Phase
      # --------------------------------------------------
      - name: Sheets FORMAT phase (retry-safe)
        run: |
          set -e
          for i in 1 2 3; do
            echo "▶ FORMAT phase attempt $i"
            SHEETS_PHASE=FORMAT python -m src.scripts.sync_to_sheets && exit 0
            sleep $((i * 20))
          done
          exit 1

      # --------------------------------------------------
      # Persist canonical SQLite snapshot
      # --------------------------------------------------
      - name: Publish SQLite snapshot to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: db-latest
          name: Deal Pipeline SQLite (Latest)
          files: db/deals.sqlite
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Record end time and duration
        if: always()
        run: |
          JOB_END_TS=$(date +%s)
          echo "JOB_END_TS=$JOB_END_TS" >> $GITHUB_ENV
          echo "JOB_DURATION_MIN=$(( (JOB_END_TS - JOB_START_TS) / 60 ))" >> $GITHUB_ENV

      # --------------------------------------------------
      # Detect script-level failures
      # --------------------------------------------------
      - name: Detect script failures
        if: always()
        run: |
          if [ -f pipeline_failures.json ]; then
            echo "HAS_FAILURES=true" >> $GITHUB_ENV
      
            {
              echo "FAILED_SCRIPTS_TEXT<<EOF"
              jq -r '.[]' pipeline_failures.json | sed 's/^/- /'
              echo "EOF"
            } >> $GITHUB_ENV
          else
            echo "HAS_FAILURES=false" >> $GITHUB_ENV
          fi

      # --------------------------------------------------
      # SLACK Notifications
      # --------------------------------------------------
      - name: Notify Slack – Failure
        if: env.HAS_FAILURES == 'true'
        uses: slackapi/slack-github-action@v1
        with:
          channel-id: ${{ secrets.SLACK_PIPELINE_JOB_UPDATE_CHANNEL_ID }}
          payload: |
            {
              "text": "*${{ github.workflow }}*\nStatus: *FAILED*\nFailed scripts:\n${{ env.FAILED_SCRIPTS_TEXT }}\nDuration: *${{ env.JOB_DURATION_MIN }} min*\nRun: <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View logs>"
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

      - name: Notify Slack – Success
        if: env.HAS_FAILURES != 'true'
        uses: slackapi/slack-github-action@v1
        with:
          channel-id: ${{ secrets.SLACK_PIPELINE_JOB_UPDATE_CHANNEL_ID }}
          payload: |
            {
              "text": "*${{ github.workflow }}*\nStatus: *SUCCESS*\nDuration: *${{ env.JOB_DURATION_MIN }} min*\nRun: <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View logs>"
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}