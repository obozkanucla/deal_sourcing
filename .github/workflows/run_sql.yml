name: Run SQL Code

on:
  workflow_dispatch:

permissions:
  contents: write
  actions: read
  id-token: write

jobs:
  pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    env:
      PLAYWRIGHT_HEADLESS: "1"
      PIPELINE_ENV: prod

    steps:
      # --------------------------------------------------
      # Checkout
      # --------------------------------------------------
      - name: Checkout repo
        uses: actions/checkout@v4

      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/252263644220/locations/global/workloadIdentityPools/github-actions-pool/providers/github-provider
          service_account: sqlite-to-sheets@deal-pipeline-sync.iam.gserviceaccount.com

      # --------------------------------------------------
      # Python
      # --------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # --------------------------------------------------
      # Restore canonical SQLite DB
      # --------------------------------------------------
      - name: Inspect release assets (sanity check)   # <<<
        run: |
          gh release view db-latest --json assets \
            --jq '.assets[] | "\(.id) \(.name)"'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download deals.sqlite (print asset ID)
        run: |
          mkdir -p db
          ASSET_ID=$(gh release view db-latest --json assets \
            --jq '.assets[] | select(.name=="deals.sqlite") | .id')
      
          if [ -z "$ASSET_ID" ]; then
            echo "❌ No deals.sqlite asset found"
            exit 1
          fi
      
          echo "⬇️ Downloading asset ID: $ASSET_ID"
      
          gh release download db-latest \
            --pattern deals.sqlite \
            --output db/deals.sqlite \
            --clobber || echo "No existing DB found — starting fresh"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check DB checksum BEFORE SQL
        run: sha256sum db/deals.sqlite

      # --------------------------------------------------
      # (Optional) Run migrations
      # --------------------------------------------------
      - name: Run SQL
        run: python -m src.scripts.run_sql
      #
      # - name: Check DB checksum AFTER SQL
      #   run: sha256sum db/deals.sqlite

      # --------------------------------------------------
      # Debug schema
      # --------------------------------------------------
      - name: Total deals by source
        run: |
          sqlite3 db/deals.sqlite <<'SQL'
          SELECT source, COUNT(*) FROM deals GROUP BY source;
          SQL
      - name: Total deals with descrition by source
        run: |
          sqlite3 db/deals.sqlite <<'SQL'
          SELECT
            source,
            COUNT(*) AS total,
            SUM(description IS NOT NULL) AS with_description
          FROM deals
          GROUP BY source;
          SQL
      - name: Total deals with detailed data by source
        run: |
          sqlite3 db/deals.sqlite <<'SQL'
          SELECT
            source,
            SUM(detail_fetched_at IS NOT NULL) AS detailed
          FROM deals
          GROUP BY source;
      - name: Debug SQLite schema
        run: |
          python - << 'EOF'
          import sqlite3
          from pathlib import Path

          db = Path("db/deals.sqlite")
          print("DB exists:", db.exists())
          print("DB size:", db.stat().st_size)

          conn = sqlite3.connect(db)
          cur = conn.cursor()

          print("\n--- deals schema ---")
          for r in cur.execute("PRAGMA table_info(deals)"):
              print(r)

          print("\n--- row count ---")
          print(cur.execute("SELECT COUNT(*) FROM deals").fetchone())
          
          print(cur.execute("""SELECT
                                COUNT(*) AS total,
                                SUM(needs_detail_refresh = 0) AS not_refreshable,
                                SUM(drive_folder_id IS NULL) AS missing_folder,
                                SUM(NOT EXISTS (
                                      SELECT 1
                                      FROM deal_artifacts a
                                      WHERE a.deal_id = deals.id
                                    )) AS missing_artifacts
                              FROM deals
                              WHERE source = 'Abercorn'
                                AND (status IS NULL OR status != 'Lost');"""))
          conn.close()
          EOF

      # --------------------------------------------------
      # Enforce single-asset truth BEFORE upload
      # --------------------------------------------------
      - name: Delete existing deals.sqlite asset        # <<<
        run: |
          gh release delete-asset db-latest deals.sqlite -y || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish SQLite snapshot to GitHub Release # <<<
        uses: softprops/action-gh-release@v2
        with:
          tag_name: db-latest
          name: Deal Pipeline SQLite (Latest)
          files: db/deals.sqlite
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}