name: Deal Pipeline Reporting

on:
#  schedule:
#    - cron: "0 8 * * 5"   # Friday 08:00 UTC
  workflow_dispatch:      # allow manual runs

permissions:
  contents: write   # required for GitHub Releases
  actions: read

jobs:
  pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    env:
      PLAYWRIGHT_HEADLESS: "1"

      # -----------------------------
      # Broker credentials
      # -----------------------------
      BB_USERNAME: ${{ secrets.BB_USERNAME }}
      BB_PASSWORD: ${{ secrets.BB_PASSWORD }}

      # -----------------------------
      # Slack
      # -----------------------------
      SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
      SLACK_DEFAULT_CHANNEL_ID: ${{ secrets.SLACK_DEFAULT_CHANNEL_ID }}
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      # -----------------------------
      # Pipeline safety
      # -----------------------------
      PIPELINE_ENV: prod

    steps:
      # --------------------------------------------------
      # Checkout code
      # --------------------------------------------------
      - name: Checkout repo
        uses: actions/checkout@v4

      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/252263644220/locations/global/workloadIdentityPools/github-actions-pool/providers/github-provider
          service_account: sqlite-to-sheets@deal-pipeline-sync.iam.gserviceaccount.com

      # --------------------------------------------------
      # Python
      # --------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # --------------------------------------------------
      # Playwright
      # --------------------------------------------------
      - name: Install Playwright browsers
        run: |
          python -m playwright install chromium --with-deps

      # --------------------------------------------------
      # Restore canonical SQLite DB from GitHub Release
      # --------------------------------------------------
      - name: Download latest SQLite DB from release (if exists)
        run: |
          mkdir -p db
          gh release download db-latest \
            --pattern deals.sqlite \
            --output db/deals.sqlite \
            --clobber || echo "No existing DB found â€” starting fresh"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # --------------------------------------------------
      # Run Slack reporting for funnel, change & snapshot
      # --------------------------------------------------
      - name: Pipeline reporting to Slack
        env:
          FORCE_CURRENT_WEEK: "1"
        run: python -m src.scripts.orchestration.orchestrate_reporting

      # --------------------------------------------------
      # Persist canonical SQLite snapshot
      # --------------------------------------------------
      - name: Publish SQLite snapshot to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: db-latest
          name: Deal Pipeline SQLite (Latest)
          files: db/deals.sqlite
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}